<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <title>Technicolor Preview</title>
    <style>
      :root {
        color-scheme: light dark;
        font-family: "Inter", "Segoe UI", -apple-system, BlinkMacSystemFont,
          "Helvetica Neue", sans-serif;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: #05070f;
        color: #fff;
        display: flex;
        flex-direction: column;
      }

      main {
        position: relative;
        flex: 1;
        isolation: isolate;
        overflow: hidden;
      }

      video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        filter: url(#technicolorFilter);
      }

      .controls {
        position: fixed;
        bottom: 1rem;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem 1.6rem;
        border-radius: 18px;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(14px);
        width: min(95vw, 620px);
      }

      .action-row {
        width: 100%;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
      }

      button {
        padding: clamp(0.85rem, 1vw + 0.5rem, 1.1rem) clamp(1rem, 1vw + 0.8rem, 1.4rem);
        font-size: clamp(1rem, 1vw + 0.9rem, 1.3rem);
        font-weight: 600;
        border-radius: 16px;
        border: none;
        background: #e62e2e;
        color: #fff;
        cursor: pointer;
        transition: opacity 0.2s ease, transform 0.2s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      button:disabled {
        background: #552b2b;
        cursor: not-allowed;
      }

      button:active {
        transform: translateY(1px);
      }

      .status {
        text-align: center;
        font-size: 0.9rem;
        min-height: 1.2em;
        color: #d1d5f9;
      }

      #captureButton {
        display: none;
        flex: 0 0 auto;
        min-width: clamp(200px, 45vw, 320px);
        padding: clamp(1rem, 2vw + 0.6rem, 1.8rem);
        border-radius: 999px;
        font-size: clamp(1.1rem, 2vw + 0.8rem, 1.6rem);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin: 0 auto;
      }

      #captureButton .button-icon {
        display: inline-flex;
        margin-right: 0.7rem;
      }

      #captureButton .button-label {
        display: inline-block;
      }

      #captureButton svg {
        width: clamp(24px, 3vw, 36px);
        height: clamp(24px, 3vw, 36px);
        fill: currentColor;
      }

      #switchButton {
        display: none;
        flex: 0 0 auto;
        margin-left: auto;
        border-radius: 999px;
        padding: clamp(0.7rem, 1vw + 0.4rem, 1rem) clamp(1rem, 1vw + 0.6rem, 1.2rem);
        background: rgba(255, 255, 255, 0.15);
        font-size: clamp(0.95rem, 0.8vw + 0.8rem, 1.1rem);
      }

      .start-overlay {
        position: fixed;
        inset: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        background: rgba(0, 0, 0, 0.8);
        z-index: 2;
        transition: opacity 0.3s ease;
      }

      .start-overlay.hidden {
        opacity: 0;
        pointer-events: none;
      }

      #startButton {
        font-size: clamp(1.1rem, 3vw + 0.8rem, 1.8rem);
        padding: clamp(1rem, 3vw + 0.8rem, 1.8rem) clamp(2rem, 6vw + 1rem, 3rem);
        border-radius: 999px;
      }

      .filters-svg {
        position: absolute;
        width: 0;
        height: 0;
        pointer-events: none;
      }

      @media (max-width: 640px) {
        .controls {
          bottom: 0.5rem;
        }

        .status {
          font-size: 0.85rem;
        }

        #switchButton {
          order: 2;
        }

        #captureButton {
          order: 1;
        }
      }
    </style>
  </head>
  <body>
    <svg class="filters-svg">
      <filter id="technicolorFilter">
        <feColorMatrix 
          type="matrix" 
          values="1.1 0 0 0 0
                  0 0.9 0 0 0
                  0 0 0.85 0 0
                  0 0 0 1 0" 
          result="colorBalance"
        />

        <feComponentTransfer in="colorBalance" result="contrastCurves">
          <feFuncR type="table" tableValues="0.03 0.1 0.25 0.45 0.65 0.85 1.0"/>
          <feFuncG type="table" tableValues="0.02 0.15 0.35 0.55 0.75 0.95 1.0"/>
          <feFuncB type="table" tableValues="0.04 0.15 0.30 0.5 0.7 0.9 0.95"/>
        </feComponentTransfer>

        <feColorMatrix 
          in="contrastCurves" 
          type="saturate" 
          values="1.45" 
          result="saturated"
        />

        <feColorMatrix 
          in="saturated" 
          type="matrix" 
          values="1.1 -0.1 -0.1 0 0
                  -0.05 1.1 -0.05 0 0
                  -0.05 -0.05 1.1 0 0
                  0 0 0 1 0" 
          result="selectiveColor"
        />

        <feTurbulence 
          type="fractalNoise" 
          baseFrequency="0.75" 
          numOctaves="2" 
          stitchTiles="stitch" 
          result="noise"
        />
        <feColorMatrix 
          in="noise" 
          type="matrix" 
          values="1 0 0 0 0
                  0 1 0 0 0
                  0 0 1 0 0
                  0 0 0 0.15 0" 
          result="softNoise"
        />
        
        <feBlend in="softNoise" in2="selectiveColor" mode="overlay" result="final"/>
      </filter>
    </svg>

    <main>
      <video id="cameraFeed" autoplay playsinline></video>
    </main>
    <div class="start-overlay" id="startOverlay">
      <button id="startButton">Start Technicolor Cam</button>
    </div>
    <div class="controls">
      <div class="action-row">
        <button id="captureButton" disabled>
          <span class="button-icon" aria-hidden="true">
            <svg viewBox="0 0 64 64" focusable="false">
              <path
                d="M22 16a4 4 0 0 1 4-4h12a4 4 0 0 1 4 4h8a6 6 0 0 1 6 6v24a6 6 0 0 1-6 6H14a6 6 0 0 1-6-6V22a6 6 0 0 1 6-6h8Zm22 10a12 12 0 1 0 0 24 12 12 0 0 0 0-24Zm0 6a6 6 0 1 1 0 12 6 6 0 0 1 0-12Z"
              />
            </svg>
          </span>
          <span class="button-label">Take Photo</span>
        </button>
        <button id="switchButton" disabled>Switch Camera</button>
      </div>
      <div class="status" id="status">Allow camera access to begin.</div>
    </div>

    <script>
      const video = document.getElementById("cameraFeed");
      const button = document.getElementById("startButton");
      const status = document.getElementById("status");
      const captureButton = document.getElementById("captureButton");
      const switchButton = document.getElementById("switchButton");
      const startOverlay = document.getElementById("startOverlay");
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");
      let stream;
      let currentFacing = "environment";

      async function startCamera(options = {}) {
        const {
          facingMode = currentFacing,
          showRetryOverlay = true,
        } = options;
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          status.textContent =
            "Camera access is not supported in this browser.";
          button.disabled = true;
          return;
        }

        const previousStream = stream;
        try {
          status.textContent = "Starting camera…";
          button.disabled = true;
          const newStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode, width: { ideal: 1920 }, height: { ideal: 1080 } },
            audio: false,
          });
          stream = newStream;
          currentFacing = facingMode;
          video.srcObject = newStream;
          await video.play();
          status.textContent = "";
          startOverlay.classList.add("hidden");
          button.disabled = true;
          captureButton.style.display = "block";
          captureButton.disabled = false;
          switchButton.style.display = "block";
          switchButton.disabled = false;
          if (previousStream) {
            previousStream.getTracks().forEach((track) => track.stop());
          }
        } catch (error) {
          console.error(error);
          const hadStream = Boolean(previousStream);
          status.textContent = hadStream
            ? "Unable to switch camera. Keeping current view."
            : "Unable to access the camera. Check permissions and try again.";
          if (showRetryOverlay) {
            button.disabled = false;
            button.textContent = "Try Again";
            startOverlay.classList.remove("hidden");
          }
          if (!hadStream) {
            captureButton.style.display = "none";
            captureButton.disabled = true;
            switchButton.style.display = "none";
            switchButton.disabled = true;
          } else {
            captureButton.style.display = "block";
            captureButton.disabled = false;
            switchButton.style.display = "block";
            switchButton.disabled = false;
          }
        }
      }

      function capturePhoto() {
        if (!stream) {
          status.textContent = "Start the camera first.";
          return;
        }

        const width = video.videoWidth || 1280;
        const height = video.videoHeight || 720;
        canvas.width = width;
        canvas.height = height;
        
        ctx.filter = "url(#technicolorFilter)";
        ctx.drawImage(video, 0, 0, width, height);
        ctx.filter = "none";

        const timestamp = new Date().toISOString().replace(/[:.]/g, "-");
        const filename = `technicolor-${timestamp}.png`;
        canvas.toBlob((blob) => {
          if (!blob) {
            status.textContent = "Could not capture photo.";
            return;
          }

          const url = URL.createObjectURL(blob);
          const link = document.createElement("a");
          link.href = url;
          link.download = filename;
          document.body.appendChild(link);
          link.click();
          link.remove();
          setTimeout(() => URL.revokeObjectURL(url), 1000);
          status.textContent = `Saved ${filename} locally.`;
        }, "image/png");
      }

      function switchCamera() {
        const nextFacing =
          currentFacing === "environment" ? "user" : "environment";
        switchButton.disabled = true;
        captureButton.disabled = true;
        status.textContent = "Switching camera…";
        startCamera({ facingMode: nextFacing, showRetryOverlay: false });
      }

      window.addEventListener("DOMContentLoaded", () => startCamera());
      button.addEventListener("click", () => startCamera());
      captureButton.addEventListener("click", capturePhoto);
      switchButton.addEventListener("click", switchCamera);
    </script>
  </body>
</html>